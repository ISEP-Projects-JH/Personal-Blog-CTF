<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQLi-CTF | Research Lab</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<header class="site-header">
    <div class="container header-inner">
        <a href="index.html" class="logo">
            <span>//</span> SQLi-CTF
        </a>
        <nav class="nav-links">
            <a href="#">Documentation</a>
            <a href="#">CVE Database</a>
            <a href="admin_login.html" class="nav-link-admin" title="Administrator Access">
                Admin Portal
            </a>
            <button onclick="toggleLogin()">Member Login</button>
        </nav>
    </div>
</header>

<div class="hero">
    <div class="container">
        <span class="badge">Vulnerability Research</span>
        <h1>Anatomy of Dependency Failure</h1>
        <p>
            Exploring <strong>CVE-2019-12989</strong> through the lens of unsafe SQL construction in database
            abstraction layers.
            This environment demonstrates how application code that appears to use parameterized queries correctly can
            still be
            compromised when the underlying database library performs insecure query interpolation instead of true
            parameter
            binding.
        </p>
        <p>
            When <code>CTF_MODE=ctf</code> is enabled, the application uses an intentionally vulnerable
            <code>fakeMySqldb</code> implementation; otherwise, it defaults to <code>pymysql</code>.
            The challenge highlights that secure business logic alone is insufficient—comprehensive testing and timely
            dependency upgrades are essential before deploying to production.
        </p>

        <div style="font-size: 13px; color: #64748b; margin-top: 20px;">
            Reference: <a href="#" style="color: #94a3b8;">Dependency-Level Vulnerability Model</a>
        </div>

        <button onclick="document.getElementById('content-area').scrollIntoView({behavior: 'smooth'})"
                style="margin-top: 30px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3);">
            Access Case Studies
        </button>
    </div>
</div>

<main class="container" id="content-area">

    <section style="margin-bottom: 60px; margin-top: 40px;">
        <div class="section-header">
            <h2>Why Databases Become Unsafe</h2>
        </div>
        <div class="grid-3">
            <article class="info-card">
                <h4>The Illusion of Safety</h4>
                <p>
                    Developers often assume database libraries automatically prevent injection attacks.
                    In reality, safety depends on whether dependencies truly implement secure parameter binding.
                    This risk exists across all languages and technology stacks.
                </p>
            </article>
            <article class="info-card">
                <h4>Dependency Isolation</h4>
                <p>
                    This challenge uses the <code>ctf_sql</code> library from the SQLi-CTF project.
                    By default, it relies on <code>pymysql</code> to avoid native <code>libmysqlclient</code> dynamic
                    linking and ABI
                    compatibility issues. In CTF mode, an intentionally unsafe <code>fake_MySqldb</code> backend is
                    provided, supporting
                    normal business operations while allowing insecure parameter interpolation.
                </p>
            </article>
            <article class="info-card">
                <h4>The Attack Vector</h4>
                <p>
                    Unsafe query construction allows attackers to inject additional conditions into SQL statements.
                    By appending expressions such as <code>' AND 1=1 -- </code>, an attacker can preserve the original filter
                    logic while
                    breaking out of quoted context, enabling precise data extraction for a chosen target.
                </p>
            </article>
        </div>
    </section>

    <section>
        <div class="section-header">
            <h2>Public Threads</h2>
        </div>
        <div id="posts" class="grid-3">
            <div style="grid-column: 1/-1; text-align: center; color: var(--color-text-muted); padding: 40px;">
                Initializing database connection...
            </div>
        </div>
    </section>

</main>

<div id="loginOverlay" class="login-overlay">
    <div id="loginBox">
        <button class="close-btn" onclick="toggleLogin()">&times;</button>

        <h3 style="margin-top: 0; margin-bottom: 20px; color: var(--color-text-main);">Member Access</h3>

        <div class="form-group">
            <label for="loginEmail">Email Address</label>
            <input id="loginEmail" placeholder="user@example.com">
        </div>

        <div class="form-group">
            <label for="loginPassword">Password</label>
            <input id="loginPassword" type="password" placeholder="••••••••">
        </div>

        <button onclick="login()" style="width: 100%;">Sign In</button>
        <div id="loginResult" style="margin-top: 15px; text-align: center; font-size: 13px; min-height: 20px;"></div>
    </div>
</div>

<footer>
    <div class="container">
        <p>&copy; 2026 SQLi-CTF Framework.</p>
        <p style="opacity: 0.6;">Educational Environment | Do not use heavily in production.</p>
    </div>
</footer>

<script src="app.js"></script>
<script src="ctf-widget.js"></script>

<script>
    console.log("Environment Ready");

    // UI Logic
    function toggleLogin() {
        const overlay = document.getElementById("loginOverlay");
        const isHidden = getComputedStyle(overlay).display === "none";

        if (isHidden) {
            overlay.style.display = "flex";
            document.getElementById("loginEmail").focus();
        } else {
            overlay.style.display = "none";
        }
    }

    document.getElementById("loginOverlay").addEventListener("click", function (e) {
        if (e.target === this) toggleLogin();
    });

    // Login Logic
    async function login() {
        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;
        const result = document.getElementById("loginResult");

        result.textContent = "Verifying credentials...";
        result.style.color = "var(--color-text-muted)";

        try {
            const {success, username, jwt} = await API.loginUser(email, password);

            if (!success) {
                result.textContent = "Login failed: Invalid credentials";
                result.style.color = "var(--color-error)";
                return;
            }

            result.textContent = "Success! Redirecting...";
            result.style.color = "var(--color-success)";

            const u = encodeURIComponent(username);
            const t = encodeURIComponent(jwt);
            setTimeout(() => {
                window.location.href = `personal_space.html?username=${u}&jwt=${t}`;
            }, 800);

        } catch (e) {
            result.textContent = "Network Error";
            result.style.color = "var(--color-error)";
        }
    }

    // Load Home Logic - Updated with alice@example.com hint
    async function loadHome() {
        const container = document.getElementById("posts");

        try {
            const posts = await API.fetchHome();

            if (posts.length === 0) {
                container.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:40px;">No posts available.</div>`;
                return;
            }

            container.innerHTML = "";
            posts.forEach(p => {
                const div = document.createElement("div");
                div.className = "post";

                // Display user email if available, otherwise force hint format
                const displayEmail = p.email ? p.email : 'alice@example.com';

                div.innerHTML = `
                        <div class="post-title">${p.title}</div>
                        <div style="font-size:14px; color:#64748b; margin-bottom:12px;">
                            Click to expand thread analysis...
                        </div>
                        <div class="post-meta">
                            <span>
                                <strong>${p.author}</strong>
                                <span style="opacity:0.7">(${displayEmail})</span>
                            </span>
                            <span>${p.comments} Comments</span>
                        </div>
                    `;
                container.appendChild(div);
            });
        } catch (e) {
            container.innerHTML = `<div style="color:var(--color-error); text-align:center; grid-column:1/-1;">Failed to load posts.</div>`;
        }
    }

    loadHome();
</script>
</body>
</html>
